#!/bin/bash
# Git Pre-Commit Hook: Citation Verification
#
# Checks staged files for citations and verifies them against the database.
# Blocks commits containing unverified or hallucinated citations.
#
# Installation:
#   cp pre-commit-hook .git/hooks/pre-commit
#   chmod +x .git/hooks/pre-commit

set -e

# Get the repository root
REPO_ROOT="$(git rev-parse --show-toplevel)"
CITATION_CHECKER="$REPO_ROOT/citationChecker.py"

# Colors for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

echo ""
echo "ğŸ“š Checking citations in staged files..."

# Check if citation checker exists
if [ ! -f "$CITATION_CHECKER" ]; then
    echo -e "${YELLOW}âš ï¸  Citation checker not found. Skipping verification.${NC}"
    echo "Install: Copy citationChecker.py to repository root"
    exit 0
fi

# Get staged files (exclude binary files)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | \
               grep -E '\.(md|txt|py|ts|tsx|js|jsx)$' || true)

if [ -z "$STAGED_FILES" ]; then
    echo -e "${GREEN}âœ… No text files staged${NC}"
    echo ""
    exit 0
fi

# Check each staged file
UNVERIFIED_FILES=""
TOTAL_UNVERIFIED=0

for file in $STAGED_FILES; do
    # Get the staged content (not working directory)
    CONTENT=$(git show ":$file" 2>/dev/null || true)

    if [ -z "$CONTENT" ]; then
        continue
    fi

    # Run citation checker in quiet mode
    if ! echo "$CONTENT" | python3 "$CITATION_CHECKER" --stdin --quiet 2>/dev/null; then
        UNVERIFIED_FILES="$UNVERIFIED_FILES\n  - $file"
        ((TOTAL_UNVERIFIED++)) || true
    fi
done

# Report results
if [ $TOTAL_UNVERIFIED -eq 0 ]; then
    echo -e "${GREEN}âœ… All citations verified${NC}"
    echo ""
    exit 0
else
    echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${RED}âŒ COMMIT BLOCKED: Unverified citations found${NC}"
    echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    echo -e "Files with unverified citations:"
    echo -e "$UNVERIFIED_FILES"
    echo ""
    echo "Run citation checker manually for details:"
    echo "  python3 citationChecker.py --file <filename>"
    echo ""
    echo "To commit anyway (not recommended):"
    echo "  git commit --no-verify"
    echo ""
    echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""

    # Block commit (change to 'exit 0' to allow with warning)
    exit 1
fi
